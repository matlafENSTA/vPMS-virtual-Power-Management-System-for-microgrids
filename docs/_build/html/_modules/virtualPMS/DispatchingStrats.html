

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>virtualPMS.DispatchingStrats &mdash; virtualPMS 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            virtualPMS
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README_doc.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Working Directory: docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">virtualPMS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">virtualPMS.DispatchingStrats</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for virtualPMS.DispatchingStrats</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding:utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">:Created: 2025-06-19 10:41:51</span>
<span class="sd">:Project: virtual PMS for microgrids</span>
<span class="sd">:Version: 1.0</span>
<span class="sd">:Author: Mathieu Lafitte</span>
<span class="sd">:Description: Dispatching strategies implemented : Load Following (LFE), Cycle Charging (CCE) and a modular strategy based on cost comparison (CostStrat).</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1">#---------------------</span>
<span class="c1">#%%</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))))</span> <span class="c1"># add the entire module to python path</span>

<span class="kn">from</span> <span class="nn">virtualPMS</span> <span class="kn">import</span> <span class="n">Battery</span><span class="p">,</span> <span class="n">BatteryStock</span><span class="p">,</span> <span class="n">DieselGenerator</span><span class="p">,</span> <span class="n">Grid</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<div class="viewcode-block" id="LFE_CCE_emergency_system">
<a class="viewcode-back" href="../../virtualPMS.html#virtualPMS.DispatchingStrats.LFE_CCE_emergency_system">[docs]</a>
<span class="k">def</span> <span class="nf">LFE_CCE_emergency_system</span><span class="p">(</span><span class="n">strat</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dfIN</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">grid_1</span><span class="p">:</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">BattStock</span><span class="p">:</span> <span class="n">BatteryStock</span><span class="p">,</span> <span class="n">DG_1</span><span class="p">:</span> <span class="n">DieselGenerator</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">SOClim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forecast_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load Following and Cycle Charging dispatching routine. </span>
<span class="sd">    Preserve system&#39;s components : when energy is missing, priority goes to grid &gt; batteries &gt; DG.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        strat (str): &quot;lfe&quot; for Load Following strategy, &quot;cce&quot; for Cycle Charging strategy</span>
<span class="sd">        dfIN (pd.DataFrame): input dataframe. Content : &quot;Time&quot;: list or np.array of datetime.datetime objects</span>
<span class="sd">                                                        &quot;Load&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">                                                        &quot;Green Prod&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">        ActiveDevices (dict): {&quot;Grid&quot;: True/False, &quot;Batteries&quot;: True/False, &quot;DieselGenerator&quot;: True/False} : enter True for using the device, False to disable it.</span>
<span class="sd">        grid_1 (Grid): the grid used during simulation</span>
<span class="sd">        BattStock (BatteryStock): the battery stock used during simulation</span>
<span class="sd">        DG_1 (DieselGenerator): the diesel generator used during simulation</span>
<span class="sd">        dt (float): duration of the time step, in hours</span>
<span class="sd">        SOClim (float, optional): under this SOC, batteries will be charged by the grid (when the grid is reliable). </span>
<span class="sd">                                   NB : if you don&#39;t want to charge the batteries with the grid power at all, enter SOClim = 0. Defaults to 0.7.</span>
<span class="sd">        forecast (bool, optional): If True, future data will be used to dispatch power.</span>
<span class="sd">                                   If False, only current and past data will be used. Defaults to False.</span>
<span class="sd">        forecast_period (float, optional): will only be used when forecast == True. based on the duration of battery charging and forecast abilities, </span>
<span class="sd">                                           it represents the future period of time the function is allowed to look at in order to anticipate dispatching, IN HOURS. </span>
<span class="sd">                                           Defaults to 24.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict, dict: Power and others time series.</span>
<span class="sd">            main:</span>
<span class="sd">                TimeArray [datetime]: dfIN[&quot;Time&quot;]</span>
<span class="sd">                P_L [kWh]: dfIN[&quot;Load&quot;]</span>
<span class="sd">                P_L_modif [kWh]: load power effectively supplied (clipped) (&gt;=0)</span>
<span class="sd">                P_green [kWh]: dfIN[&quot;Green Prod&quot;] (&gt;=0)</span>
<span class="sd">                P_grid [kWh]: grid power output</span>
<span class="sd">                P_bat [kWh]: battery stock power output</span>
<span class="sd">                P_diesel [kWh]: diesel generator power output (&gt;=0)</span>
<span class="sd">                SOC [%]: State Of Charge of the battery stock (0&lt;=SOC&lt;=1)</span>
<span class="sd">                F_C [L]: fuel remaining in the tank (&gt;=0)</span>
<span class="sd">            others:</span>
<span class="sd">                P_net [kWh]: P_green - P_L</span>
<span class="sd">                P_net_modif [kWh]: P_green - P_L_modif</span>
<span class="sd">                P_diff [kWh]: Excess (&gt;0) and Deficit (&lt;0) power. = P_green + P_grid + P_bat + P_diesel - P_L</span>
<span class="sd">                P_resistor [kWh]: Excess of power that couldn&#39;t be used, neither sold : it goes to a resistor (&gt;0)</span>
<span class="sd">            debug:</span>
<span class="sd">                indic [int]: indicates which branch of if-else was chosen at every time step</span>
<span class="sd">                RuntimeDG [int]: indicates how many time steps the diesel generator was running</span>
<span class="sd">            allSOCs [dict]: time series of the SOC of every battery of the tank</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TimeArray</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])</span>
    <span class="n">P_L</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Load&quot;</span><span class="p">]</span>
    <span class="n">P_green</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Green Prod&quot;</span><span class="p">]</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_L</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_green</span><span class="p">))</span>
    
    <span class="c1"># time series</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_net</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L</span>  <span class="c1"># Production - Load power (kW).</span>

    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># [kW] clipped electrical load</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># [kW] Grid OUTPUT power (&lt;0 when selling and &gt;0 when buying)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># [kW] Battery OUTPUT power (&lt;0 when charging and &gt;0 when discharging).</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [%]  State-of-charge of the whole stock of batteries (0 to 1).</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># [kW] Power supplied by the Diesel Generator (&gt;=0).</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [L]  Fuel remaining in the tank (L)</span>
    <span class="n">grid_state_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">forecast_period</span><span class="o">/</span><span class="n">dt</span><span class="p">)]))</span>
    
    <span class="c1"># debug &amp; details</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">indic</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># indicates in which if/else branch each time step is</span>
    <span class="n">allSOCs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># saves the timeserie of every SOC of every battery</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">)):</span>
        <span class="n">allSOCs</span><span class="p">[</span><span class="s1">&#39;bat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># BattStocks_debug = []</span>

    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># SIMULATION</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">bat_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allSOCs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">allSOCs</span><span class="p">[</span><span class="n">bat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SOC</span><span class="p">)</span>
        <span class="n">F_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span><span class="p">)</span>
        <span class="n">SOC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">())</span>
        <span class="n">RuntimeDG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>                                                                                              <span class="c1"># green power excess</span>
            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>                                                         <span class="c1"># battery charging</span>
                <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pbat_ch_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># remaining power to the grid if connected</span>
                <span class="c1"># P_resistor.append(P_net[i] - Pbat_ch_i) # renewable prod clipping</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>                                                                                      <span class="c1"># selling to the grid</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>                                                                                                     <span class="c1"># battery full and grid unavailable : resistor</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># P_resistor.append(P_net[i]) # renewable prod clipping</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>                                                                                                            <span class="c1"># green power deficit</span>
            <span class="c1"># print(&#39;belif   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;pnet&#39;,abs(P_net[i]),&#39;P_bat&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
            <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">MinimumRuntime</span><span class="p">:</span>                                        <span class="c1"># purchasing from the grid</span>
                <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="k">if</span> <span class="n">forecast</span> <span class="ow">and</span> <span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">SOClim</span> <span class="ow">or</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">grid_state_long</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">forecast_period</span><span class="o">/</span><span class="n">dt</span><span class="p">)]):</span>   <span class="c1"># battery charging using grid</span>
                    <span class="n">Pmax_bat</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_Pmax</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">)</span>
                    <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pmax_bat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_ch_i</span> <span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                                                                                 <span class="c1"># grid supplies load</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_Pmax</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;dis&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">MinimumRuntime</span><span class="p">:</span> <span class="c1"># battery discharging</span>
                <span class="c1"># battery power sufficient</span>
                <span class="c1"># print(&#39;bchar   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;pnet&#39;,abs(P_net[i]),&#39;P_bat&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
                <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">)</span>
                <span class="c1"># print(&#39;achar   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;P_bat_real&#39;,Pbat_dis_i,&#39;P_bat_sim&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
                <span class="c1"># if Pbat_dis_i &lt; abs(P_net[i]):</span>
                <span class="c1">#     BattStocks_debug.append([[copy.deepcopy(b) for b in BattStock], P_net[i], dt])</span>
                <span class="c1">#     print(&#39;idx&#39;,i,&#39;time&#39;, time[i],&#39;p_disch&#39;, Pbat_dis_i, &#39;soc&#39;, get_SOC(BattStock,&#39;soc&#39;))</span>
                <span class="c1"># assert(Pbat_dis_i == abs(P_net[i]))</span>
                <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span><span class="p">)</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>                                                                                                     <span class="c1"># running DG</span>
                <span class="n">P_DG_asked</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">Pnom</span> <span class="k">if</span> <span class="n">strat</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;cce&#39;</span> <span class="k">else</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">F_Cons</span><span class="p">,</span> <span class="n">Pdiesel_i</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">run_DG</span><span class="p">(</span><span class="n">P_DG_asked</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">])</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pdiesel_i</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">+=</span> <span class="n">dt</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span> <span class="o">-=</span> <span class="n">F_Cons</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">TankCapacity</span>
                <span class="k">if</span> <span class="n">Pdiesel_i</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>                                                                          <span class="c1"># DG power unsufficient</span>
                    <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pdiesel_i</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span> <span class="o">+</span> <span class="n">P_grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># load clipping</span>
                    <span class="c1"># P_resistor.append(0)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                                                                                 <span class="c1"># DG power sufficient</span>
                    <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pdiesel_i</span> <span class="o">+</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pbat_ch_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># print(&#39;p_dg&#39;,Pdiesel_i,&#39;soc&#39;,get_SOC(BattStock))</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
                    <span class="c1"># P_resistor.append(P_green[-1] + P_bat[-1] + P_diesel[-1] - P_L_modif[-1]) # DG output clipping</span>
                <span class="c1"># print(round(F_Cons * dt / DG_1.TankCapacity,3), round(DG_1.FuelRate,3))</span>
    
    <span class="c1"># OUTPUT</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_L_modif</span><span class="p">)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span>
    <span class="n">P_net_modif</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L_modif</span>
    <span class="n">P_diff</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">+</span> <span class="n">P_grid</span> <span class="o">+</span> <span class="n">P_bat</span> <span class="o">+</span> <span class="n">P_diesel</span> <span class="o">-</span> <span class="n">P_L</span>
    <span class="n">P_resistor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">pow</span><span class="p">)</span> <span class="k">for</span> <span class="nb">pow</span> <span class="ow">in</span> <span class="n">P_diff</span><span class="p">])</span>

    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RuntimeDG</span><span class="p">)</span>

    <span class="n">DictOut_TS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TimeArray&quot;</span><span class="p">:</span><span class="n">TimeArray</span><span class="p">,</span> <span class="s2">&quot;P_L&quot;</span><span class="p">:</span><span class="n">P_L</span><span class="p">,</span> <span class="s2">&quot;P_L_modif&quot;</span><span class="p">:</span><span class="n">P_L_modif</span><span class="p">,</span> <span class="s2">&quot;P_green&quot;</span><span class="p">:</span><span class="n">P_green</span><span class="p">,</span> <span class="s2">&quot;P_net&quot;</span><span class="p">:</span><span class="n">P_net</span><span class="p">,</span> <span class="s2">&quot;P_net_modif&quot;</span><span class="p">:</span><span class="n">P_net_modif</span><span class="p">,</span> 
                  <span class="s2">&quot;P_diff&quot;</span><span class="p">:</span><span class="n">P_diff</span><span class="p">,</span> <span class="s2">&quot;P_resistor&quot;</span><span class="p">:</span><span class="n">P_resistor</span><span class="p">,</span> <span class="s2">&quot;indic&quot;</span><span class="p">:</span><span class="n">indic</span><span class="p">}</span> <span class="c1"># only time series</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Grid&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_grid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_grid</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Batteries&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_bat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_bat</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;SOC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOC</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_bat</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SOC</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_diesel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_diesel</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;F_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_C</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;RuntimeDG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RuntimeDG</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F_C</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dfOut_TS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">DictOut_TS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfOut_TS</span><span class="p">,</span> <span class="n">allSOCs</span></div>


<div class="viewcode-block" id="LFE_CCE_self_sufficiency">
<a class="viewcode-back" href="../../virtualPMS.html#virtualPMS.DispatchingStrats.LFE_CCE_self_sufficiency">[docs]</a>
<span class="k">def</span> <span class="nf">LFE_CCE_self_sufficiency</span><span class="p">(</span><span class="n">strat</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dfIN</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">grid_1</span><span class="p">:</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">BattStock</span><span class="p">:</span> <span class="n">BatteryStock</span><span class="p">,</span> <span class="n">DG_1</span><span class="p">:</span> <span class="n">DieselGenerator</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">SOClim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forecast_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load Following and Cycle Charging dispatching routine. </span>
<span class="sd">    Optimize the self sufficiency : when energy is missing, priority goes to batteries &gt; DG &gt; grid.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        strat (str): &quot;lfe&quot; for Load Following strategy, &quot;cce&quot; for Cycle Charging strategy</span>
<span class="sd">        dfIN (pd.DataFrame): input dataframe. Content : &quot;Time&quot;: list or np.array of datetime.datetime objects</span>
<span class="sd">                                                        &quot;Load&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">                                                        &quot;Green Prod&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">        ActiveDevices (dict): {&quot;Grid&quot;: True/False, &quot;Batteries&quot;: True/False, &quot;DieselGenerator&quot;: True/False} : enter True for using the device, False to disable it.</span>
<span class="sd">        grid_1 (Grid): the grid used during simulation</span>
<span class="sd">        BattStock (BatteryStock): the battery stock used during simulation</span>
<span class="sd">        DG_1 (DieselGenerator): the diesel generator used during simulation</span>
<span class="sd">        dt (float): duration of the time step, in hours</span>
<span class="sd">        SOClim (float, optional): under this SOC, batteries will be charged by the grid (when the grid is reliable). </span>
<span class="sd">                                   NB : if you don&#39;t want to charge the batteries with the grid power at all, enter SOClim = 0. Defaults to 0.7.</span>
<span class="sd">        forecast (bool, optional): If True, future data will be used to dispatch power.</span>
<span class="sd">                                   If False, only current and past data will be used. Defaults to False.</span>
<span class="sd">        forecast_period (float, optional): will only be used when forecast == True. based on the duration of battery charging and forecast abilities, </span>
<span class="sd">                                           it represents the future period of time the function is allowed to look at in order to anticipate dispatching, IN HOURS. </span>
<span class="sd">                                           Defaults to 24.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict, dict: Power and others time series.</span>
<span class="sd">            main:</span>
<span class="sd">                TimeArray [datetime]: dfIN[&quot;Time&quot;]</span>
<span class="sd">                P_L [kWh]: dfIN[&quot;Load&quot;]</span>
<span class="sd">                P_L_modif [kWh]: load power effectively supplied (clipped) (&gt;=0)</span>
<span class="sd">                P_green [kWh]: dfIN[&quot;Green Prod&quot;] (&gt;=0)</span>
<span class="sd">                P_grid [kWh]: grid power output</span>
<span class="sd">                P_bat [kWh]: battery stock power output</span>
<span class="sd">                P_diesel [kWh]: diesel generator power output (&gt;=0)</span>
<span class="sd">                SOC [%]: State Of Charge of the battery stock (0&lt;=SOC&lt;=1)</span>
<span class="sd">                F_C [L]: fuel remaining in the tank (&gt;=0)</span>
<span class="sd">            others:</span>
<span class="sd">                P_net [kWh]: P_green - P_L</span>
<span class="sd">                P_net_modif [kWh]: P_green - P_L_modif</span>
<span class="sd">                P_diff [kWh]: Excess (&gt;0) and Deficit (&lt;0) power. = P_green + P_grid + P_bat + P_diesel - P_L</span>
<span class="sd">                P_resistor [kWh]: Excess of power that couldn&#39;t be used, neither sold : it goes to a resistor (&gt;0)</span>
<span class="sd">            debug:</span>
<span class="sd">                indic [int]: indicates which branch of if-else was chosen at every time step</span>
<span class="sd">                RuntimeDG [int]: indicates how many time steps the diesel generator was running</span>
<span class="sd">            allSOCs [dict]: time series of the SOC of every battery of the tank</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TimeArray</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">])</span>
    <span class="n">P_L</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Load&quot;</span><span class="p">]</span>
    <span class="n">P_green</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Green Prod&quot;</span><span class="p">]</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_L</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_green</span><span class="p">))</span>
    
    <span class="c1"># time series</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_net</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L</span>  <span class="c1"># Production - Load power (kW).</span>

    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># [kW] clipped electrical load</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># [kW] Grid OUTPUT power (&lt;0 when selling and &gt;0 when buying)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># [kW] Battery OUTPUT power (&lt;0 when charging and &gt;0 when discharging).</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [%]  State-of-charge of the whole stock of batteries (0 to 1).</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># [kW] Power supplied by the Diesel Generator (&gt;=0).</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [L]  Fuel remaining in the tank (L)</span>
    <span class="n">grid_state_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">forecast_period</span><span class="o">/</span><span class="n">dt</span><span class="p">)]))</span>
    
    <span class="c1"># debug &amp; details</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">indic</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># indicates in which if/else branch each time step is</span>
    <span class="n">allSOCs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># saves the timeserie of every SOC of every battery</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">)):</span>
        <span class="n">allSOCs</span><span class="p">[</span><span class="s1">&#39;bat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># BattStocks_debug = []</span>

    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># SIMULATION</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">bat_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allSOCs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">allSOCs</span><span class="p">[</span><span class="n">bat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SOC</span><span class="p">)</span>
        <span class="n">F_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span><span class="p">)</span>
        <span class="n">SOC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">())</span>
        <span class="n">RuntimeDG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>                                                                                            <span class="c1"># green power excess</span>
            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>                                                       <span class="c1"># battery charging</span>
                <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pbat_ch_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># remaining power to the grid if connected</span>
                <span class="c1"># P_resistor.append(P_net[i] - Pbat_ch_i) # renewable prod clipping</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>                                                                                    <span class="c1"># selling to the grid</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>                                                                                                   <span class="c1"># battery full and grid unavailable : resistor</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># P_resistor.append(P_net[i]) # renewable prod clipping</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>                                                                                                       <span class="c1"># green power deficit</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_Pmax</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;dis&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">MinimumRuntime</span><span class="p">:</span>    <span class="c1"># battery discharging</span>
                <span class="c1"># battery power sufficient</span>
                <span class="c1"># print(&#39;bchar   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;pnet&#39;,abs(P_net[i]),&#39;P_bat&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
                <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">)</span>
                <span class="c1"># print(&#39;achar   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;P_bat_real&#39;,Pbat_dis_i,&#39;P_bat_sim&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
                <span class="c1"># if Pbat_dis_i &lt; abs(P_net[i]):</span>
                <span class="c1">#     BattStocks_debug.append([[copy.deepcopy(b) for b in BattStock], P_net[i], dt])</span>
                <span class="c1">#     print(&#39;idx&#39;,i,&#39;time&#39;, time[i],&#39;p_disch&#39;, Pbat_dis_i, &#39;soc&#39;, get_SOC(BattStock,&#39;soc&#39;))</span>
                <span class="c1"># assert(Pbat_dis_i == abs(P_net[i]))</span>
                <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span><span class="p">)</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">&lt;</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">MinimumRuntime</span> <span class="ow">or</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                     <span class="c1"># running DG</span>
                <span class="n">P_DG_asked</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">Pnom</span> <span class="k">if</span> <span class="n">strat</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;cce&#39;</span> <span class="k">else</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">F_Cons</span><span class="p">,</span> <span class="n">Pdiesel_i</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">run_DG</span><span class="p">(</span><span class="n">P_DG_asked</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">])</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pdiesel_i</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">+=</span> <span class="n">dt</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span> <span class="o">-=</span> <span class="n">F_Cons</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">TankCapacity</span>
                <span class="k">if</span> <span class="n">Pdiesel_i</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>                                                                        <span class="c1"># DG power unsufficient</span>
                    <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pdiesel_i</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span> <span class="o">+</span> <span class="n">P_grid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># load clipping</span>
                    <span class="c1"># P_resistor.append(0)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                                                                               <span class="c1"># DG power sufficient</span>
                    <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pdiesel_i</span> <span class="o">+</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="c1"># print(&#39;p_dg&#39;,Pdiesel_i,&#39;soc&#39;,get_SOC(BattStock))</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pbat_ch_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                    <span class="c1"># P_resistor.append(P_green[-1] + P_bat[-1] + P_diesel[-1] - P_L_modif[-1]) # DG output clipping</span>
                <span class="c1"># print(round(F_Cons * dt / DG_1.TankCapacity,3), round(DG_1.FuelRate,3))</span>
            <span class="c1"># print(&#39;belif   max&#39;,get_Pmax(BattStock,dt,&#39;dis&#39;),&#39;pnet&#39;,abs(P_net[i]),&#39;P_bat&#39;,get_Pbat(BattStock,abs(P_net[i]),dt))</span>
            <span class="k">elif</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                                                               <span class="c1"># purchasing from the grid</span>
                <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># P_resistor.append(0)</span>
                <span class="k">if</span> <span class="n">forecast</span> <span class="ow">and</span> <span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">SOClim</span> <span class="ow">or</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">grid_state_long</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">forecast_period</span><span class="o">/</span><span class="n">dt</span><span class="p">)]):</span> <span class="c1"># battery charging using grid</span>
                    <span class="n">Pmax_bat</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_Pmax</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">)</span>
                    <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pmax_bat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_ch_i</span> <span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                                                                               <span class="c1"># grid supplies load</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="c1"># else: every possibility should have already been processed (cf grid state 0 or 1)</span>

    <span class="c1"># OUTPUT</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_L_modif</span><span class="p">)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span>
    <span class="n">P_net_modif</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L_modif</span>
    <span class="n">P_diff</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">+</span> <span class="n">P_grid</span> <span class="o">+</span> <span class="n">P_bat</span> <span class="o">+</span> <span class="n">P_diesel</span> <span class="o">-</span> <span class="n">P_L</span>
    <span class="n">P_resistor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">pow</span><span class="p">)</span> <span class="k">for</span> <span class="nb">pow</span> <span class="ow">in</span> <span class="n">P_diff</span><span class="p">])</span>

    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RuntimeDG</span><span class="p">)</span>

    <span class="n">DictOut_TS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TimeArray&quot;</span><span class="p">:</span><span class="n">TimeArray</span><span class="p">,</span> <span class="s2">&quot;P_L&quot;</span><span class="p">:</span><span class="n">P_L</span><span class="p">,</span> <span class="s2">&quot;P_L_modif&quot;</span><span class="p">:</span><span class="n">P_L_modif</span><span class="p">,</span> <span class="s2">&quot;P_green&quot;</span><span class="p">:</span><span class="n">P_green</span><span class="p">,</span> <span class="s2">&quot;P_net&quot;</span><span class="p">:</span><span class="n">P_net</span><span class="p">,</span> <span class="s2">&quot;P_net_modif&quot;</span><span class="p">:</span><span class="n">P_net_modif</span><span class="p">,</span> 
                  <span class="s2">&quot;P_diff&quot;</span><span class="p">:</span><span class="n">P_diff</span><span class="p">,</span> <span class="s2">&quot;P_resistor&quot;</span><span class="p">:</span><span class="n">P_resistor</span><span class="p">,</span> <span class="s2">&quot;indic&quot;</span><span class="p">:</span><span class="n">indic</span><span class="p">}</span> <span class="c1"># only time series</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Grid&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_grid</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_grid</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Batteries&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_bat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_bat</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;SOC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOC</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_bat</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SOC</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_diesel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_diesel</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;F_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_C</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;RuntimeDG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RuntimeDG</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F_C</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dfOut_TS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">DictOut_TS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfOut_TS</span><span class="p">,</span> <span class="n">allSOCs</span></div>


<div class="viewcode-block" id="CostStrat">
<a class="viewcode-back" href="../../virtualPMS.html#virtualPMS.DispatchingStrats.CostStrat">[docs]</a>
<span class="k">def</span> <span class="nf">CostStrat</span><span class="p">(</span><span class="n">dfIN</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">grid_1</span><span class="p">:</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">BattStock</span><span class="p">:</span> <span class="n">BatteryStock</span><span class="p">,</span> <span class="n">DG_1</span><span class="p">:</span> <span class="n">DieselGenerator</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ChargeUsingGridCost</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forecast_period</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy based on costs dispatching routine. </span>
<span class="sd">    Decisions are taken after the calculation of use costs of every device.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dfIN (pd.DataFrame): input dataframe. Content : &quot;Time&quot;: list or np.array of datetime.datetime objects</span>
<span class="sd">                                                        &quot;Load&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">                                                        &quot;Green Prod&quot;: list or np.array of floats (&gt;=0)</span>
<span class="sd">        ActiveDevices (dict): {&quot;Grid&quot;: True/False, &quot;Batteries&quot;: True/False, &quot;DieselGenerator&quot;: True/False} : enter True for using the device, False to disable it.</span>
<span class="sd">        grid_1 (Grid): the grid used during simulation</span>
<span class="sd">        BattStock (BatteryStock): the battery stock used during simulation</span>
<span class="sd">        DG_1 (DieselGenerator): the diesel generator used during simulation</span>
<span class="sd">        dt (float): duration of the time step, in hours</span>
<span class="sd">        ChargeUsingGridCost (float, optional): if the cost of 1kWh purchased from the grid is less than this, it will be used to charge batteries. Defaults to 0.</span>
<span class="sd">        forecast (bool, optional): If True, future data will be used to dispatch power.</span>
<span class="sd">                                   If False, only current and past data will be used. Defaults to False.</span>
<span class="sd">        forecast_period (float, optional): will only be used when forecast == True. based on the duration of battery charging and forecast abilities, </span>
<span class="sd">                                           it represents the future period of time the function is allowed to look at in order to anticipate dispatching, IN HOURS. </span>
<span class="sd">                                           Defaults to 24.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict, dict: Power and others time series.</span>
<span class="sd">            main:</span>
<span class="sd">                TimeArray [datetime]: dfIN[&quot;Time&quot;]</span>
<span class="sd">                P_L [kWh]: dfIN[&quot;Load&quot;]</span>
<span class="sd">                P_L_modif [kWh]: load power effectively supplied (clipped) (&gt;=0)</span>
<span class="sd">                P_green [kWh]: dfIN[&quot;Green Prod&quot;] (&gt;=0)</span>
<span class="sd">                P_grid [kWh]: grid power output</span>
<span class="sd">                P_bat [kWh]: battery stock power output</span>
<span class="sd">                P_diesel [kWh]: diesel generator power output (&gt;=0)</span>
<span class="sd">                SOC [%]: State Of Charge of the battery stock (0&lt;=SOC&lt;=1)</span>
<span class="sd">                F_C [L]: fuel remaining in the tank (&gt;=0)</span>
<span class="sd">            others:</span>
<span class="sd">                P_net [kWh]: P_green - P_L</span>
<span class="sd">                P_net_modif [kWh]: P_green - P_L_modif</span>
<span class="sd">                P_diff [kWh]: Excess (&gt;0) and Deficit (&lt;0) power. = P_green + P_grid + P_bat + P_diesel - P_L</span>
<span class="sd">                P_resistor [kWh]: Excess of power that couldn&#39;t be used, neither sold : it goes to a resistor (&gt;0)</span>
<span class="sd">            debug:</span>
<span class="sd">                indic [int]: indicates which branch of if-else was chosen at every time step</span>
<span class="sd">                RuntimeDG [int]: indicates how many time steps the diesel generator was running</span>
<span class="sd">            allSOCs [dict]: time series of the SOC of every battery of the tank </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">TimeArray</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Time&quot;</span><span class="p">]</span>
    <span class="n">P_L</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Load&quot;</span><span class="p">]</span>
    <span class="n">P_green</span> <span class="o">=</span> <span class="n">dfIN</span><span class="p">[</span><span class="s2">&quot;Green Prod&quot;</span><span class="p">]</span>

    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_L</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_green</span><span class="p">))</span>

    <span class="c1"># time series</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_net</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L</span>  <span class="c1"># Production - Load power (kW).</span>

    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c1"># [kW] clipped electrical load</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># [kW] Grid OUTPUT power (&lt;0 when selling and &gt;0 when buying)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c1"># [kW] Battery OUTPUT power (&lt;0 when charging and &gt;0 when discharging).</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [%]  State-of-charge of the whole stock of batteries (0 to 1).</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># [kW] Power supplied by the Diesel Generator (&gt;=0).</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># [L]  Fuel remaining in the tank (L)</span>
    
    <span class="c1"># debug &amp; details</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">indic</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># indicates in which if/else branch each time step is</span>
    <span class="n">allSOCs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># saves the timeserie of every SOC of every battery</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">)):</span>
        <span class="n">allSOCs</span><span class="p">[</span><span class="s1">&#39;bat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">GridSaleCost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BatteryChargeCost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">GridPurchaseCost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BatteryDischargeCost_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">DGUseCost_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># SIMULATION</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="c1"># to understand &#39;Yes&#39; and &#39;No&#39; comments, refer to the practical diagram</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">bat_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allSOCs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">allSOCs</span><span class="p">[</span><span class="n">bat_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">SOC</span><span class="p">)</span>
        <span class="n">F_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span><span class="p">)</span>
        <span class="n">SOC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BattStock</span><span class="o">.</span><span class="n">get_SOC</span><span class="p">())</span>
        <span class="n">RuntimeDG</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span><span class="p">)</span>

        <span class="n">GridSaleCost</span> <span class="o">=</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">sale_cost</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">BatteryChargeCost</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">charge_cost</span><span class="p">(</span><span class="n">grid_1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Batteries&quot;</span><span class="p">],</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">forecast_period</span><span class="p">)</span>
        <span class="n">GridSaleCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GridSaleCost</span><span class="p">)</span>
        <span class="n">BatteryChargeCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatteryChargeCost</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                                                                              <span class="c1"># P_green = P_load</span>
            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">GridPurchaseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">BatteryDischargeCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">DGUseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                                                                                             <span class="c1"># green power excess</span>
            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">BatteryChargeCost</span> <span class="o">&lt;</span> <span class="n">GridSaleCost</span><span class="p">:</span>                                                                       <span class="c1"># selling to the grid</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>                                                                                                     <span class="c1"># battery charging</span>
                <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dt</span><span class="p">)</span>
                <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_ch_i</span> <span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">GridPurchaseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">BatteryDischargeCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">DGUseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>                                                                                                          <span class="c1"># green power deficit</span>
            <span class="n">f_cons</span><span class="p">,</span> <span class="n">Pdiesel_i</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">run_DG</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">])</span> <span class="c1"># simulation to see if running the DG is worth the effort (time series are not updated here)</span>
            <span class="n">GridPurchaseCost</span> <span class="o">=</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">purchase_cost</span><span class="p">(</span><span class="n">TimeArray</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">BatteryDischargeCost</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">discharge_cost</span><span class="p">(</span><span class="n">grid_1</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Batteries&quot;</span><span class="p">])</span>
            <span class="n">DGUseCost</span> <span class="o">=</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">use_cost</span><span class="p">(</span><span class="n">f_cons</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">Pdiesel_i</span><span class="p">,</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">])</span>
            <span class="n">GridPurchaseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GridPurchaseCost</span><span class="p">)</span>
            <span class="n">BatteryDischargeCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BatteryDischargeCost</span><span class="p">)</span>
            <span class="n">DGUseCost_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DGUseCost</span><span class="p">)</span>
            <span class="c1"># print(grid_state[i],&#39;GridSaleCost&#39;, round(GridSaleCost,3), &#39;BatteryChargeCost&#39;, round(BatteryChargeCost,3), &#39;GridPurchaseCost&#39;, round(GridPurchaseCost,3), &#39;BatteryDischargeCost&#39;, round(BatteryDischargeCost,3), &#39;DGUseCost&#39;, round(DGUseCost,3))</span>
            <span class="k">if</span> <span class="n">GridPurchaseCost</span> <span class="o">&lt;</span> <span class="n">BatteryDischargeCost</span> <span class="ow">and</span> <span class="n">GridPurchaseCost</span> <span class="o">&lt;</span> <span class="n">DGUseCost</span><span class="p">:</span>                                                                                    <span class="c1"># purchasing from the grid</span>
                <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">GridPurchaseCost</span> <span class="o">&lt;</span> <span class="n">ChargeUsingGridCost</span><span class="p">:</span>                                                             <span class="c1"># battery charging with the grid</span>
                    <span class="n">Pmax_bat</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">get_Pmax</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;ch&#39;</span><span class="p">)</span>
                    <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pmax_bat</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>                                                                                                  <span class="c1"># grid supplying only the load</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>                                                                                                     <span class="c1"># grid too expensive or disconnected</span>
                <span class="k">if</span> <span class="n">BatteryDischargeCost</span> <span class="o">&lt;</span> <span class="n">DGUseCost</span><span class="p">:</span>                                                                   <span class="c1"># battery discharging</span>
                    <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">)</span>
                    <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span><span class="p">)</span>
                    <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                    <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>                                                                                                 <span class="c1"># running DG</span>
                    <span class="n">P_diesel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pdiesel_i</span><span class="p">)</span> <span class="c1"># the DG is really running</span>
                    <span class="n">DG_1</span><span class="o">.</span><span class="n">cur_runtime</span> <span class="o">+=</span> <span class="n">dt</span>
                    <span class="n">DG_1</span><span class="o">.</span><span class="n">FuelRate</span> <span class="o">-=</span> <span class="n">f_cons</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">DG_1</span><span class="o">.</span><span class="n">TankCapacity</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">Pdiesel_i</span><span class="p">:</span>                                                                      <span class="c1"># DG power sufficient</span>
                        <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">BatteryChargeCost</span> <span class="o">&lt;</span> <span class="n">GridSaleCost</span><span class="p">:</span>                                                           <span class="c1"># selling DG excess to the grid</span>
                            <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span><span class="p">)</span>
                            <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">:</span>                                                                                         <span class="c1"># battery charging with DG excess</span>
                            <span class="n">Pbat_ch_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_charge</span><span class="p">(</span><span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">dt</span><span class="p">)</span>
                            <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">Pbat_ch_i</span> <span class="o">-</span> <span class="n">Pdiesel_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">Pbat_ch_i</span><span class="p">)</span>
                            <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">:</span>                                                                                             <span class="c1"># DG power unsufficient</span>
                        <span class="k">if</span> <span class="n">GridPurchaseCost</span> <span class="o">&lt;</span> <span class="n">BatteryDischargeCost</span><span class="p">:</span>                                                    <span class="c1"># purchasing from the grid</span>
                            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span><span class="p">)</span>
                            <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">:</span>                                                                                         <span class="c1"># battery discharging</span>
                            <span class="n">Pbat_dis_i</span> <span class="o">=</span> <span class="n">BattStock</span><span class="o">.</span><span class="n">battery_stock_discharge</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Pdiesel_i</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
                            <span class="n">P_L_modif</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">P_green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Pdiesel_i</span> <span class="o">+</span> <span class="n">Pbat_dis_i</span><span class="p">)</span> <span class="c1"># load clipping</span>
                            <span class="n">P_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span> <span class="n">P_net</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Pdiesel_i</span> <span class="o">-</span> <span class="n">Pbat_dis_i</span> <span class="k">if</span> <span class="n">grid_1</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">P_bat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pbat_dis_i</span><span class="p">)</span>
                            <span class="n">indic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># OUTPUT</span>
    <span class="c1"># --------------------------------------------------------------------------------------------</span>
    <span class="n">P_L_modif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_L_modif</span><span class="p">)</span>
    <span class="n">P_bat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span>
    <span class="n">P_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span>
    <span class="n">P_diesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span>
    <span class="n">F_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span>
    <span class="n">SOC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span>
    <span class="n">P_net_modif</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">-</span> <span class="n">P_L_modif</span>
    <span class="n">P_diff</span> <span class="o">=</span> <span class="n">P_green</span> <span class="o">+</span> <span class="n">P_grid</span> <span class="o">+</span> <span class="n">P_bat</span> <span class="o">+</span> <span class="n">P_diesel</span> <span class="o">-</span> <span class="n">P_L</span>
    <span class="n">P_resistor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">pow</span><span class="p">)</span> <span class="k">for</span> <span class="nb">pow</span> <span class="ow">in</span> <span class="n">P_diff</span><span class="p">])</span>

    <span class="n">RuntimeDG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RuntimeDG</span><span class="p">)</span>

    <span class="n">DictOut_TS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;TimeArray&quot;</span><span class="p">:</span><span class="n">TimeArray</span><span class="p">,</span> <span class="s2">&quot;P_L&quot;</span><span class="p">:</span><span class="n">P_L</span><span class="p">,</span> <span class="s2">&quot;P_L_modif&quot;</span><span class="p">:</span><span class="n">P_L_modif</span><span class="p">,</span> <span class="s2">&quot;P_green&quot;</span><span class="p">:</span><span class="n">P_green</span><span class="p">,</span> <span class="s2">&quot;P_net&quot;</span><span class="p">:</span><span class="n">P_net</span><span class="p">,</span> <span class="s2">&quot;P_net_modif&quot;</span><span class="p">:</span><span class="n">P_net_modif</span><span class="p">,</span> 
                  <span class="s2">&quot;P_diff&quot;</span><span class="p">:</span><span class="n">P_diff</span><span class="p">,</span> <span class="s2">&quot;P_resistor&quot;</span><span class="p">:</span><span class="n">P_resistor</span><span class="p">,</span> <span class="s2">&quot;indic&quot;</span><span class="p">:</span><span class="n">indic</span><span class="p">}</span> <span class="c1"># only time series</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Grid&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_grid</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;GridPurchaseCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GridPurchaseCost_list</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;GridSaleCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GridSaleCost_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_grid</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_grid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;DieselGenerator&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_diesel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_diesel</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;F_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F_C</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;DGUseCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DGUseCost_list</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;RuntimeDG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RuntimeDG</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_diesel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">F_C</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">F_C</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ActiveDevices</span><span class="p">[</span><span class="s2">&quot;Batteries&quot;</span><span class="p">]:</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;P_bat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_bat</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;SOC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SOC</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;BatteryDischargeCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BatteryDischargeCost_list</span>
        <span class="n">DictOut_TS</span><span class="p">[</span><span class="s2">&quot;BatteryChargeCost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BatteryChargeCost_list</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P_bat</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">P_bat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SOC</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">SOC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">14</span><span class="p">)])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">dfOut_TS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">DictOut_TS</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfOut_TS</span><span class="p">,</span> <span class="n">allSOCs</span></div>


<span class="c1"># test section</span>
<span class="c1"># -----------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="kn">import</span> <span class="nn">virtualPMS.TimeSeriesAnalysis</span> <span class="k">as</span> <span class="nn">TSA</span>

    <span class="c1"># time series</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># sampling period in hours</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>                                           <span class="c1"># change value</span>
    <span class="c1"># lenght of the period you want to study, in days :</span>
    <span class="n">period</span> <span class="o">=</span> <span class="mi">15</span>                                                                 <span class="c1"># change value</span>
    <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">period</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">TimeArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">i</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)])</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">TimeArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">/</span> <span class="n">num_steps</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)])</span>
    <span class="n">P_green</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span>     <span class="c1"># non controlled power supply : solar panels, wind turbines... </span>
    <span class="n">P_L</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span>         <span class="c1"># load demand</span>
    <span class="n">GridStateNormal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_steps</span> <span class="o">-</span> <span class="n">num_steps</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_steps</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># grid reliable or not at t</span>
    <span class="n">df_TS</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Time&quot;</span><span class="p">:</span><span class="n">TimeArray</span><span class="p">,</span><span class="s2">&quot;Load&quot;</span><span class="p">:</span><span class="n">P_L</span><span class="p">,</span><span class="s2">&quot;Green Prod&quot;</span><span class="p">:</span> <span class="n">P_green</span><span class="p">,</span> <span class="s2">&quot;Grid State&quot;</span><span class="p">:</span> <span class="n">GridStateNormal</span><span class="p">})</span>

    <span class="c1"># all components allowed</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="n">PlotNormal</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># --- components definition ---</span>
    <span class="n">ActiveDevicesNormal</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Grid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;DieselGenerator&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="c1"># grid</span>
    <span class="n">GridNormal</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">GridStateNormal</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Grid</span><span class="o">.</span><span class="n">GridPricesRef</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Grid</span><span class="o">.</span><span class="n">GridScheduleRef</span><span class="p">))</span> 

    <span class="c1"># batteries</span>
    <span class="n">paramIn_batt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;capacity&#39;</span><span class="p">:</span><span class="mi">800</span><span class="p">,</span>
                    <span class="s1">&#39;SOC&#39;</span><span class="p">:</span><span class="mf">0.2</span><span class="p">,</span> 
                    <span class="s1">&#39;SOCmin&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
                    <span class="s1">&#39;SOCmax&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="s1">&#39;eta&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">,</span>
                    <span class="s1">&#39;Pmax_ch&#39;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span>
                    <span class="s1">&#39;Pmax_disch&#39;</span><span class="p">:</span><span class="mi">150</span><span class="p">,</span>
                    <span class="s1">&#39;lifetime&#39;</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;ReplacementCost&#39;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
                    <span class="s1">&#39;MaintenanceCost&#39;</span><span class="p">:</span><span class="mf">0.03</span><span class="p">}</span>
    
    <span class="n">battery_1</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span><span class="n">paramIn_batt</span><span class="p">)</span>
    <span class="n">battery_2</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span><span class="n">paramIn_batt</span><span class="p">)</span>
    <span class="n">battery_3</span> <span class="o">=</span> <span class="n">Battery</span><span class="p">(</span><span class="n">paramIn_batt</span><span class="p">)</span>

    <span class="n">BattStockNormal</span> <span class="o">=</span> <span class="n">BatteryStock</span><span class="p">([</span>
                                <span class="n">battery_1</span><span class="p">,</span>
                                <span class="n">battery_2</span><span class="p">,</span>
                                <span class="n">battery_3</span>
                              <span class="p">])</span>
    
    <span class="c1"># diesel generator</span>
    <span class="n">paramInDGNormal</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Pmax&quot;</span><span class="p">:</span><span class="mi">400</span><span class="p">,</span>
        <span class="s2">&quot;Pnom&quot;</span><span class="p">:</span><span class="mi">380</span><span class="p">,</span>
        <span class="s2">&quot;Pmin&quot;</span><span class="p">:</span><span class="mi">370</span><span class="p">,</span>
        <span class="s2">&quot;TankCapacity&quot;</span><span class="p">:</span><span class="mi">2000</span><span class="p">,</span>
        <span class="s2">&quot;FuelRate&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;f_r_min&quot;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="s2">&quot;lifetime&quot;</span><span class="p">:</span><span class="mi">200000</span><span class="p">,</span>
        <span class="s2">&quot;ReplacementCost&quot;</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
        <span class="s2">&quot;MaintenanceCost&quot;</span><span class="p">:</span><span class="mf">0.08</span><span class="p">,</span>
        <span class="s2">&quot;FuelPrice&quot;</span><span class="p">:</span><span class="mf">1.5</span>
    <span class="p">}</span>
    
    <span class="n">DGNormal</span> <span class="o">=</span> <span class="n">DieselGenerator</span><span class="p">(</span><span class="n">paramInDGNormal</span><span class="p">)</span>
    <span class="n">DGNormal</span><span class="o">.</span><span class="n">find_DG_coeffs</span><span class="p">()</span>

    <span class="c1"># --- simulations ---</span>
    <span class="n">dfResNormalCostStrat</span><span class="p">,</span> <span class="n">allSOCsCostStrat</span> <span class="o">=</span> <span class="n">CostStrat</span><span class="p">(</span><span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesNormal</span><span class="p">,</span> <span class="n">GridNormal</span><span class="p">,</span> <span class="n">BattStockNormal</span><span class="p">,</span> <span class="n">DGNormal</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
    <span class="n">dfResNormalLFE</span><span class="p">,</span> <span class="n">allSOCsLFE</span> <span class="o">=</span> <span class="n">LFE_CCE_emergency_system</span><span class="p">(</span><span class="s2">&quot;lfe&quot;</span><span class="p">,</span> <span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesNormal</span><span class="p">,</span> <span class="n">GridNormal</span><span class="p">,</span> <span class="n">BattStockNormal</span><span class="p">,</span> <span class="n">DGNormal</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
    <span class="n">dfResNormalCCE</span><span class="p">,</span> <span class="n">allSOCsCCE</span> <span class="o">=</span> <span class="n">LFE_CCE_emergency_system</span><span class="p">(</span><span class="s2">&quot;cce&quot;</span><span class="p">,</span> <span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesNormal</span><span class="p">,</span> <span class="n">GridNormal</span><span class="p">,</span> <span class="n">BattStockNormal</span><span class="p">,</span> <span class="n">DGNormal</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>

    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResNormalCostStrat</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResNormalLFE</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResNormalCCE</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># only PV and Load</span>
    <span class="c1"># ----------------------------------------------</span>
    <span class="n">PlotEmpty</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># --- components definition ---</span>
    <span class="n">ActiveDevicesEmpty</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Grid&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;DieselGenerator&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

    <span class="c1"># grid</span>
    <span class="n">GridState</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">GridEmpty</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">GridState</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Grid</span><span class="o">.</span><span class="n">GridPricesRef</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Id&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Grid</span><span class="o">.</span><span class="n">GridScheduleRef</span><span class="p">))</span>

    <span class="c1"># batteries</span>
    <span class="n">BattStockEmpty</span> <span class="o">=</span> <span class="n">BatteryStock</span><span class="p">([</span><span class="n">Battery</span><span class="p">({</span>
                                            <span class="s2">&quot;capacity&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="s2">&quot;SOC&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;SOCmin&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;SOCmax&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;eta&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;Pmax_ch&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;Pmax_disch&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;lifetime&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="s2">&quot;ReplacementCost&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="s2">&quot;MaintenanceCost&quot;</span><span class="p">:</span><span class="mi">0</span>
                                            <span class="p">})])</span>
    
    <span class="c1"># diesel generator</span>
    <span class="n">paramInDGEmpty</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Pmax&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;Pnom&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;Pmin&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;TankCapacity&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;FuelRate&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;f_r_min&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;lifetime&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;ReplacementCost&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;MaintenanceCost&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;FuelPrice&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;MinimumRuntime&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    
    <span class="n">DGEmpty</span> <span class="o">=</span> <span class="n">DieselGenerator</span><span class="p">(</span><span class="n">paramInDGEmpty</span><span class="p">)</span>
    <span class="n">DGEmpty</span><span class="o">.</span><span class="n">find_DG_coeffs</span><span class="p">()</span>

    <span class="c1"># --- simulations ---</span>
    <span class="n">dfResEmptyCostStrat</span><span class="p">,</span> <span class="n">allSOCs</span> <span class="o">=</span> <span class="n">CostStrat</span><span class="p">(</span><span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesEmpty</span><span class="p">,</span> <span class="n">GridEmpty</span><span class="p">,</span> <span class="n">BattStockEmpty</span><span class="p">,</span> <span class="n">DGEmpty</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
    <span class="n">dfResEmptyLFE</span><span class="p">,</span> <span class="n">allSOCs</span> <span class="o">=</span> <span class="n">LFE_CCE_emergency_system</span><span class="p">(</span><span class="s2">&quot;lfe&quot;</span><span class="p">,</span> <span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesEmpty</span><span class="p">,</span> <span class="n">GridEmpty</span><span class="p">,</span> <span class="n">BattStockEmpty</span><span class="p">,</span> <span class="n">DGEmpty</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
    <span class="n">dfResEmptyCCE</span><span class="p">,</span> <span class="n">allSOCs</span> <span class="o">=</span> <span class="n">LFE_CCE_emergency_system</span><span class="p">(</span><span class="s2">&quot;cce&quot;</span><span class="p">,</span> <span class="n">df_TS</span><span class="p">,</span> <span class="n">ActiveDevicesEmpty</span><span class="p">,</span> <span class="n">GridEmpty</span><span class="p">,</span> <span class="n">BattStockEmpty</span><span class="p">,</span> <span class="n">DGEmpty</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>

    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResEmptyCostStrat</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResEmptyLFE</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">TSA</span><span class="o">.</span><span class="n">plot_compact</span><span class="p">(</span><span class="n">dfResEmptyCCE</span><span class="p">,</span> <span class="s2">&quot;test_output&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1"># %%</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mathieu LAFITTE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>